# 03.2 • Configurações Especiais por Máquina Antes da Instalação dos Componentes (Pré-Ambari)

Este documento reúne comandos essenciais para corrigir travamentos de pacotes, preparar diretórios necessários e garantir o funcionamento correto dos serviços em cada nó do cluster **antes** de realizar a instalação dos componentes do Hadoop/ODP via interface Ambari. Siga estas instruções em cada nó conforme especificado.

---

## Nó: master.clemlab.local

1. Criação do keystore TLS para Atlas
```bash
sudo mkdir -p /etc/atlas/conf/
sudo keytool -genkey -alias atlasserver -keyalg RSA -sigalg SHA256withRSA \
  -keystore /etc/atlas/conf/atlas.keystore -storepass  -validity 3650 \
  -dname "CN=master.clemlab.local, OU=YourUnit, O=YourOrg, L=YourCity, S=YourState, C=BR"
```

2. Ajuste permissões do keystore (erro pode ser ignorado se usuário 'atlas' não existir ainda)

```bash
sudo chmod 644 /etc/atlas/conf/atlas.keystore
```

3. Upload manual do driver JDBC do MySQL

```bash
wget https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/8.0.33/mysql-connector-j-8.0.33.jar -O mysql-connector-java.jar
sudo mv mysql-connector-java.jar /var/lib/ambari-server/resources/mysql-connector-java.jar
sudo chown root:root /var/lib/ambari-server/resources/mysql-connector-java.jar
sudo chmod 644 /var/lib/ambari-server/resources/mysql-connector-java.jar
```

4. Reinício do Ambari Server após upload do JDBC

```bash
sudo ambari-server restart
```

5. Diretório e permissões para Livy (se necessário)
```bash
sudo mkdir -p /var/lib/livy
sudo chown livy:hadoop /var/lib/livy
sudo chmod 755 /var/lib/livy
```

6. Destravar e finalizar instalação de pacotes pendentes

```bash
sudo dpkg --configure -a
sudo apt-get install -f
sudo apt update
```

7. Instalação manual de Livy Spark3 (se indicado nos logs)

```bash
sudo apt-get install livy2-1-2-4-0-108-spark3
```

---

## Nó: node1.clemlab.local

1. Finalizar configuração pendente do dpkg

```bash
sudo dpkg --configure -a
```

2. Criar diretório do Livy se erro na instalação

```bash
sudo mkdir -p /var/lib/livy
sudo chown livy:hadoop /var/lib/livy
sudo chmod 755 /var/lib/livy
sudo dpkg --configure -a
```

3. Corrigir dependências e atualizar lista de pacotes

```bash
sudo apt-get install -f
sudo apt update
```

4. Instalação manual de pacote problemático (opcional)

```bash
sudo apt-get install libsnappy1v5
```

5. Após correções, retente instalação via Ambari (interface)

---

## Nó: node2.clemlab.local

```bash
sudo dpkg --configure -a

sudo mkdir -p /var/lib/livy
sudo chown livy:hadoop /var/lib/livy
sudo chmod 755 /var/lib/livy
sudo dpkg --configure -a

sudo apt-get install -f
sudo apt update
```


### Opcional: tentar instalar pacote problemático diretamente

```bash
sudo apt-get install libsnappy1v5
```

Retente instalação via Ambari após correção


---

## Nó: node3.clemlab.local

```bash
sudo dpkg --configure -a

sudo mkdir -p /var/lib/livy
sudo chown livy:hadoop /var/lib/livy
sudo chmod 755 /var/lib/livy
sudo dpkg --configure -a

sudo apt-get install -f
sudo apt update

sudo apt-get install libsnappy1v5
```


### Opcional: verificar espaço em disco

```bash
df -h
```

Após destravar pacotes e corrigir dependências, aguarde instalação automática dos serviços via Ambari

```bash
sudo systemctl restart ambari-agent
```

Se persistir falha no Livy/Spark3, repita a criação de diretório e reconfigure

```bash
sudo mkdir -p /var/lib/livy
sudo chown livy:hadoop /var/lib/livy
sudo chmod 755 /var/lib/livy
sudo dpkg --configure -a
```

Tente novamente via interface do Ambari

---

## Observações Gerais

- **Gerenciador de pacotes `dpkg` pode travar** durante instalações interrompidas. Use:
-
  ```bash
  sudo dpkg --configure -a
  sudo apt-get install -f
  sudo apt update
  ```
- **Pacote Livy Spark3**: frequentemente apresenta erro por ausência do diretório `/var/lib/livy` — crie manualmente com permissões corretas antes de retentar.
- **Driver JDBC MySQL**: Baixe e copie manualmente para `/var/lib/ambari-server/resources/` no nó master antes da configuração via Ambari.
- **Ambari Agent**: se perceber lentidão ou travamento longo, reinicie o `ambari-agent` para agilizar a tomada de status.
- **Espaço em disco**: sempre confira (`df -h`) se há volume suficiente disponível.

---

Essas etapas devem ser seguidas **antes** de executar a instalação dos serviços na interface do Ambari. Perceba que é muito comum em todos os nós que os comandos abaixo sejam executados quando necessário, ffique atendo à isso:

```bash
sudo dpkg --configure -a
sudo apt-get install -f
sudo apt update
```

